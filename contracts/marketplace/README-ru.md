# Marketplace

Координатор сделок (продажи/аукционы/оферы/свопы) для доменов .ton и Telegram юзернеймов. 

## Хранилище
См. `contracts/marketplace/storage.tolk`:
- `ownerAddress: address`: владелец
- `publicKey: uint256`: ключ для проверки подписей скидок
- `moveUpSalePrice: coins`: цена поднятия объявления в WEB3
- `currentTopSale: address`: адрес текущей «топ» продажи
- `collectedFeesTon: uint64`: накопленные комиссии в TON
- `collectedFeesDict: dict`: накопленные комиссии в джеттонах (адрес кошелька → сумма)
- `deployInfos: dict<uint32, DeployInfo>`: описание всех доступных сделок
- `contractCodes: Cell<ContractCodes>`: коды для вычисления адресов доменов/кошельков
- `ds2: Cell<MarketplaceStorageDs2>`:
  - `web3WalletAddress: address`: адрес WEB3-кошелька для маркетплейса 
  - `promotionPrices: dict<uint32, {hotPrice(uint64), coloredPrice(uint64)}>`: стоимость продвижения продаж 
  - `userSubscriptions: dict<address, {level(uint8), endTime(uint32)}>`: информация о подписках пользователей
  - `subscriptionsInfo: dict<uint8, dict<uint32, uint64>>`: 

## Входящие сообщения

### Деплой нового предложения

Контракт принимает входящие сообщения трёх типов и на их основе развёртывает новые сделки:
- SIMPLE: обычный перевод TON от пользователя с дополнительными данными
- NFT_TRANSFER: `NftTransfer` от домена/юзернейма
- JETTON_TRANSFER: `JettonsTransferNotification` от jettonWallet

Все доступные типы сделок, их коды и параметры лежат в словаре `deployInfos`. Для каждого типа сделки хранится код контракта самой сделки и код «функции деплоя», которая исполняется внутри Marketplace и осуществляет развертывание. За деплой некоторых предложений взимается фиксированная комиссия (deployFee). 

При запросе деплоя передаются необходимые настройки сделки, а также специальный идентификатор, по которому определяется тип. Кроме этого, в запросе деплоя может быть передана информация о размере скидки на комиссию. Эта информация должна быть подписана приватным ключом на бэкенде приложения.

### Принятие комиссий за продление доменов

Все контракты webdom поддерживают продление принадлежащих им доменов. За эту возможность взимается небольшая фиксированная комиссия (не более 0.1 TON) при каждом продлении. 

### Принятие комиссий от завершенных сделок

При успешном исполнении сделок они отправляют комиссию маркетплейса (в TON или в Jettons). Маркетплейс сохраняет информацию о размере полученных средств в переменной collectedFeesTon или collectedFeesDict.

### Покупка подписок

Маркетплейс поддерживает покупку и продление подписок, которые могут давать различные преимущества при использовании приложения. Допустимы тарифные планы разных уровней и разной продолжительности.

### Обновление информации (админские функции)

Так как deployInfosDict содержит очень большой массив данных (в нем хранятся коды всех контрактов), то маркетплейс поддерживает частичное обновление этого словаря и добавление новых элементов в него. Кроме этого, доступна админская функция присваивания юзеру подписки (может пригодиться для розыгрышей).

## Get-методы
- `get_deploy_info(op: int) → (deployType, deployFee, dealCode, deployFunctionCode, specificInfo)` — возвращает запись из `deployInfos` по идентификатору сделки
- `get_storage_data() → (...)` — сводка по всем данным хранилища (см. порядок в `contract.tolk`)

